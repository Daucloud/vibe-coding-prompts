<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AGENTS.md Downloader</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #0b0f17;
        --panel: #0f1626;
        --text: #e6edf3;
        --muted: #9fb0c0;
        --border: rgba(255, 255, 255, 0.12);
        --accent: #7aa2ff;
        --good: #33d17a;
        --bad: #ff6b6b;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      }
      @media (prefers-color-scheme: light) {
        :root {
          --bg: #f6f8fb;
          --panel: #ffffff;
          --text: #111827;
          --muted: #4b5563;
          --border: rgba(17, 24, 39, 0.12);
          --accent: #335dff;
          --shadow: 0 10px 30px rgba(17, 24, 39, 0.08);
        }
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
        background: var(--bg);
        color: var(--text);
      }
      .wrap {
        max-width: 860px;
        margin: 0 auto;
        padding: 40px 18px 72px;
      }
      .panel {
        margin-top: 0;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 18px;
        box-shadow: var(--shadow);
      }
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }
      h1 {
        font-size: 20px;
        margin: 0;
        letter-spacing: 0.2px;
      }
      .subtitle {
        color: var(--muted);
        font-size: 13px;
        margin-top: 6px;
        line-height: 1.35;
      }
      .status {
        font-size: 12px;
        color: var(--muted);
      }
      .status.good {
        color: var(--good);
      }
      .status.bad {
        color: var(--bad);
      }
      .row {
        margin-top: 14px;
      }
      .form {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
      }
      @media (max-width: 700px) {
        .form {
          grid-template-columns: 1fr;
        }
      }
      input,
      textarea {
        width: 100%;
        box-sizing: border-box;
        padding: 12px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.02);
        color: var(--text);
        outline: none;
      }
      input::placeholder {
        color: rgba(159, 176, 192, 0.75);
      }
      textarea {
        min-height: 86px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        line-height: 1.35;
        resize: vertical;
      }
      .actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      button {
        border: 1px solid var(--border);
        background: rgba(122, 162, 255, 0.16);
        color: var(--text);
        border-radius: 10px;
        padding: 12px 14px;
        cursor: pointer;
      }
      button:hover {
        border-color: rgba(122, 162, 255, 0.45);
      }
      button.primary {
        background: rgba(122, 162, 255, 0.22);
        border-color: rgba(122, 162, 255, 0.38);
      }
      .note {
        margin-top: 10px;
        color: var(--muted);
        font-size: 12px;
        line-height: 1.4;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        color: var(--muted);
        font-size: 12px;
        white-space: nowrap;
      }
      a {
        color: var(--accent);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.95em;
      }
      .result {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="panel">
        <div class="header">
          <div>
            <h1>AGENTS.md Downloader</h1>
            <div class="subtitle">Type <code>tool+language</code> and generate a <code>curl</code> command (no clone needed).</div>
          </div>
          <div style="display: flex; align-items: center; gap: 10px">
            <span class="pill">Pages → raw.githubusercontent.com</span>
            <span id="loadStatus" class="status">Loading…</span>
          </div>
        </div>

        <div class="row">
          <div class="form">
            <div>
              <input
                id="combo"
                inputmode="text"
                autocomplete="off"
                placeholder="codex+python"
                aria-label="tool+language"
                list="comboSuggestions"
              />
              <datalist id="comboSuggestions"></datalist>
            </div>
            <button id="generate" class="primary">Generate</button>
          </div>
          <div class="note">
            Optional query params: <code>?ref=v0.1.0&amp;dest=AGENTS.md</code>. If you host on a custom domain, set defaults in
            <a href="./registry.json">docs/registry.json</a> or pass <code>?owner=&amp;repo=</code>.
          </div>
        </div>

        <div class="result" id="result">
          <div class="row">
            <textarea id="command" readonly></textarea>
            <div class="actions">
              <button id="copyCmd">Copy command</button>
              <button id="openRaw" type="button">Open raw</button>
            </div>
            <div class="note" id="rawUrlNote"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);

      function parseQuery() {
        const params = new URLSearchParams(window.location.search);
        return {
          ref: params.get("ref") || "",
          owner: params.get("owner") || "",
          repo: params.get("repo") || "",
          dest: params.get("dest") || "",
        };
      }

      function guessOwnerRepoFromPagesUrl() {
        const host = window.location.hostname;
        const pathname = window.location.pathname.replace(/\/+$/, ""); // strip trailing slashes

        if (!host.endsWith(".github.io")) {
          return { owner: "", repo: "" };
        }

        const owner = host.split(".github.io")[0];
        const segments = pathname.split("/").filter(Boolean);
        if (segments.length >= 1) {
          return { owner, repo: segments[0] };
        }
        return { owner, repo: `${owner}.github.io` };
      }

      function shellEscapeSingleQuotes(value) {
        return String(value).replace(/'/g, "'\"'\"'");
      }

      function shellEscapeDoubleQuotes(value, { escapeDollar } = { escapeDollar: true }) {
        let out = String(value).replace(/\\/g, "\\\\").replace(/"/g, '\\"').replace(/`/g, "\\`");
        if (escapeDollar) out = out.replace(/\$/g, "\\$");
        return out;
      }

      function quoteForShell(value, { allowEnvVars } = { allowEnvVars: false }) {
        return `"${shellEscapeDoubleQuotes(value, { escapeDollar: !allowEnvVars })}"`;
      }

      function buildRawUrl({ owner, repo, ref, path }) {
        if (!owner || !repo || !ref || !path) return "";
        return `https://raw.githubusercontent.com/${owner}/${repo}/${ref}/${path}`;
      }

      function buildCommand({ rawUrl, dest }) {
        if (!rawUrl) return "";
        const destValue = dest || "AGENTS.md";
        const allowEnvVars = destValue.startsWith("$HOME/");
        const hasDir = destValue.includes("/");
        const dir = hasDir ? destValue.replace(/\/[^/]*$/, "") : "";
        const needsMkdir = hasDir && dir !== "." && dir !== "./";
        const quotedUrl = `'${shellEscapeSingleQuotes(rawUrl)}'`;
        const quotedDest = quoteForShell(destValue, { allowEnvVars });

        if (!needsMkdir) {
          return `curl -fsSL ${quotedUrl} -o ${quotedDest}`;
        }

        const quotedDir = quoteForShell(dir, { allowEnvVars });
        return `mkdir -p ${quotedDir} && curl -fsSL ${quotedUrl} -o ${quotedDest}`;
      }

      async function copyToClipboard(text) {
        await navigator.clipboard.writeText(text);
      }

      function setStatus(text, variant) {
        const el = $("loadStatus");
        el.textContent = text;
        el.classList.remove("good", "bad");
        if (variant) el.classList.add(variant);
      }

      function normalizeCombo(value) {
        const cleaned = String(value || "")
          .trim()
          .toLowerCase()
          .replace(/\s+/g, " ")
          .replace(/\+/g, " ");
        const parts = cleaned.split(" ").filter(Boolean);
        if (parts.length < 2) return { tool: "", lang: "" };
        return { tool: parts[0], lang: parts[1] };
      }

      async function main() {
        const query = parseQuery();
        const guessed = guessOwnerRepoFromPagesUrl();

        try {
          const res = await fetch("./registry.json", { cache: "no-store" });
          if (!res.ok) throw new Error(`registry fetch failed: ${res.status}`);
          const registry = await res.json();
          const items = (registry && registry.items) || [];
          const defaults = (registry && registry.defaults) || {};
          if (!Array.isArray(items) || items.length === 0) {
            throw new Error("registry has no items");
          }

          const suggestions = $("comboSuggestions");
          suggestions.innerHTML = "";
          for (const item of items) {
            const opt = document.createElement("option");
            opt.value = `${item.tool}+${item.lang}`;
            suggestions.appendChild(opt);
          }
          setStatus("Ready", "good");

          function resolveOwnerRepoRef() {
            const owner = (query.owner || guessed.owner || defaults.owner || "").trim();
            const repo = (query.repo || guessed.repo || defaults.repo || "").trim();
            const ref = (query.ref || defaults.ref || "main").trim();
            return { owner, repo, ref };
          }

          function showResult({ rawUrl, command }) {
            $("command").value = command;
            $("result").style.display = "block";
            $("rawUrlNote").innerHTML = `Raw: <a href="${rawUrl}" target="_blank" rel="noopener noreferrer"><code>${rawUrl}</code></a>`;
            $("openRaw").onclick = () => window.open(rawUrl, "_blank", "noopener,noreferrer");
          }

          function findItem(tool, lang) {
            return items.find((x) => x.tool === tool && x.lang === lang) || null;
          }

          $("generate").addEventListener("click", async () => {
            const { tool, lang } = normalizeCombo($("combo").value);
            if (!tool || !lang) {
              setStatus('Enter "tool+language" (e.g. codex+python)', "bad");
              $("result").style.display = "none";
              return;
            }

            const matched = findItem(tool, lang);
            if (!matched) {
              setStatus(`Not found: ${tool}+${lang}`, "bad");
              $("result").style.display = "none";
              return;
            }

            const { owner, repo, ref } = resolveOwnerRepoRef();
            if (!owner || !repo) {
              setStatus("Missing owner/repo. Pass ?owner=...&repo=... or set defaults in registry.json", "bad");
              $("result").style.display = "none";
              return;
            }

            const rawUrl = buildRawUrl({ owner, repo, ref, path: matched.path });
            const dest = (query.dest || "AGENTS.md").trim() || "AGENTS.md";
            const command = buildCommand({ rawUrl, dest });
            showResult({ rawUrl, command });
            setStatus(`Generated for ${tool}+${lang}`, "good");
          });

          $("copyCmd").addEventListener("click", async () => {
            const text = $("command").value;
            if (!text) return;
            await copyToClipboard(text);
            setStatus("Command copied", "good");
          });
        } catch (err) {
          setStatus(`Error: ${err && err.message ? err.message : String(err)}`, "bad");
        }
      }

      main();
    </script>
  </body>
</html>
