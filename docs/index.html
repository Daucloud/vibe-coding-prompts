<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AGENTS.md Downloader</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #0b0f17;
        --panel: #0f1626;
        --text: #e6edf3;
        --muted: #9fb0c0;
        --border: rgba(255, 255, 255, 0.12);
        --accent: #7aa2ff;
        --good: #33d17a;
        --bad: #ff6b6b;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        --chip: rgba(122, 162, 255, 0.16);
        --chip-border: rgba(122, 162, 255, 0.35);
      }
      @media (prefers-color-scheme: light) {
        :root {
          --bg: #f6f8fb;
          --panel: #ffffff;
          --text: #111827;
          --muted: #4b5563;
          --border: rgba(17, 24, 39, 0.12);
          --accent: #335dff;
          --shadow: 0 10px 30px rgba(17, 24, 39, 0.08);
          --chip: rgba(51, 93, 255, 0.12);
          --chip-border: rgba(51, 93, 255, 0.28);
        }
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
        background: var(--bg);
        color: var(--text);
      }
      .wrap {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 28px 18px;
      }
      .panel {
        width: 100%;
        max-width: 900px;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 26px 22px 20px;
        box-shadow: var(--shadow);
      }
      .header {
        text-align: center;
        margin-bottom: 18px;
      }
      h1 {
        font-size: 44px;
        margin: 0;
        letter-spacing: -0.8px;
      }
      .subtitle {
        color: var(--muted);
        font-size: 14px;
        margin-top: 10px;
        line-height: 1.35;
      }
      .status {
        font-size: 12px;
        color: var(--muted);
      }
      .status.good {
        color: var(--good);
      }
      .status.bad {
        color: var(--bad);
      }
      .row {
        margin-top: 14px;
      }
      .form {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
      }
      @media (max-width: 700px) {
        .form {
          grid-template-columns: 1fr;
        }
      }
      input,
      textarea {
        width: 100%;
        box-sizing: border-box;
        padding: 12px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.02);
        color: var(--text);
        outline: none;
      }
      input:focus,
      textarea:focus {
        border-color: rgba(122, 162, 255, 0.55);
        box-shadow: 0 0 0 4px rgba(122, 162, 255, 0.15);
      }
      input::placeholder {
        color: rgba(159, 176, 192, 0.75);
      }
      textarea {
        min-height: 86px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        line-height: 1.35;
        resize: vertical;
      }
      .actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      button {
        border: 1px solid var(--border);
        background: rgba(122, 162, 255, 0.16);
        color: var(--text);
        border-radius: 10px;
        padding: 12px 14px;
        cursor: pointer;
      }
      button:hover {
        border-color: rgba(122, 162, 255, 0.45);
      }
      button.primary {
        background: linear-gradient(135deg, rgba(122, 162, 255, 0.45), rgba(51, 209, 122, 0.35));
        border-color: rgba(122, 162, 255, 0.55);
      }
      .note {
        margin-top: 10px;
        color: var(--muted);
        font-size: 12px;
        line-height: 1.4;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        color: var(--muted);
        font-size: 12px;
        white-space: nowrap;
      }
      a {
        color: var(--accent);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.95em;
      }
      .result {
        display: none;
      }
      .meta {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-top: 12px;
      }
      .searchWrap {
        position: relative;
      }
      .searchBox {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 10px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.02);
      }
      .searchBox:focus-within {
        border-color: rgba(122, 162, 255, 0.55);
        box-shadow: 0 0 0 4px rgba(122, 162, 255, 0.15);
      }
      .searchBox input {
        border: none;
        background: transparent;
        padding: 8px 6px;
        box-shadow: none;
        border-radius: 10px;
      }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--chip-border);
        background: var(--chip);
        color: var(--text);
        font-size: 13px;
        white-space: nowrap;
      }
      .chip button {
        padding: 0;
        border: none;
        background: transparent;
        cursor: pointer;
        color: var(--muted);
        font-size: 16px;
        line-height: 1;
      }
      .chip button:hover {
        color: var(--text);
      }
      .dropdown {
        position: absolute;
        left: 0;
        right: 0;
        top: calc(100% + 8px);
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--panel);
        box-shadow: var(--shadow);
        overflow: hidden;
        display: none;
        z-index: 20;
      }
      .dropdown.open {
        display: block;
      }
      .option {
        padding: 12px 12px;
        cursor: pointer;
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 10px;
      }
      .option:hover,
      .option.active {
        background: rgba(122, 162, 255, 0.12);
      }
      .optionTitle {
        font-size: 14px;
      }
      .optionMeta {
        color: var(--muted);
        font-size: 12px;
        white-space: nowrap;
      }
      .tinyLink {
        margin-top: 8px;
        color: var(--muted);
        font-size: 12px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="panel">
        <div class="header">
          <h1>AGENTS.md</h1>
          <div class="subtitle">Search a template, then generate a <code>curl</code> command.</div>
          <div class="meta">
            <span class="pill">raw.githubusercontent.com</span>
            <span id="loadStatus" class="status">Loading…</span>
          </div>
        </div>

        <div class="row">
          <div class="form">
            <div class="searchWrap">
              <div class="searchBox" id="searchBox">
                <span class="chip" id="selectedChip" style="display: none">
                  <span id="selectedLabel"></span>
                  <button id="clearSelection" type="button" aria-label="Clear selection">×</button>
                </span>
                <input id="query" inputmode="text" autocomplete="off" placeholder="Search (e.g. codex python)" />
              </div>
              <div class="dropdown" id="dropdown" role="listbox" aria-label="Search results"></div>
            </div>
            <button id="generate" class="primary">Generate</button>
          </div>
        </div>

        <div class="result" id="result">
          <div class="row">
            <textarea id="command" readonly></textarea>
            <div class="actions">
              <button id="copyCmd">Copy command</button>
              <button id="openRaw" type="button">Open raw</button>
            </div>
            <div class="tinyLink" id="rawUrlNote"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);

      function parseQuery() {
        const params = new URLSearchParams(window.location.search);
        return {
          ref: params.get("ref") || "",
          owner: params.get("owner") || "",
          repo: params.get("repo") || "",
          dest: params.get("dest") || "",
          q: params.get("q") || "",
        };
      }

      function guessOwnerRepoFromPagesUrl() {
        const host = window.location.hostname;
        const pathname = window.location.pathname.replace(/\/+$/, ""); // strip trailing slashes

        if (!host.endsWith(".github.io")) {
          return { owner: "", repo: "" };
        }

        const owner = host.split(".github.io")[0];
        const segments = pathname.split("/").filter(Boolean);
        if (segments.length >= 1) {
          return { owner, repo: segments[0] };
        }
        return { owner, repo: `${owner}.github.io` };
      }

      function shellEscapeSingleQuotes(value) {
        return String(value).replace(/'/g, "'\"'\"'");
      }

      function shellEscapeDoubleQuotes(value, { escapeDollar } = { escapeDollar: true }) {
        let out = String(value).replace(/\\/g, "\\\\").replace(/"/g, '\\"').replace(/`/g, "\\`");
        if (escapeDollar) out = out.replace(/\$/g, "\\$");
        return out;
      }

      function quoteForShell(value, { allowEnvVars } = { allowEnvVars: false }) {
        return `"${shellEscapeDoubleQuotes(value, { escapeDollar: !allowEnvVars })}"`;
      }

      function buildRawUrl({ owner, repo, ref, path }) {
        if (!owner || !repo || !ref || !path) return "";
        return `https://raw.githubusercontent.com/${owner}/${repo}/${ref}/${path}`;
      }

      function buildCommand({ rawUrl, dest }) {
        if (!rawUrl) return "";
        const destValue = dest || "AGENTS.md";
        const allowEnvVars = destValue.startsWith("$HOME/");
        const hasDir = destValue.includes("/");
        const dir = hasDir ? destValue.replace(/\/[^/]*$/, "") : "";
        const needsMkdir = hasDir && dir !== "." && dir !== "./";
        const quotedUrl = `'${shellEscapeSingleQuotes(rawUrl)}'`;
        const quotedDest = quoteForShell(destValue, { allowEnvVars });

        if (!needsMkdir) {
          return `curl -fsSL ${quotedUrl} -o ${quotedDest}`;
        }

        const quotedDir = quoteForShell(dir, { allowEnvVars });
        return `mkdir -p ${quotedDir} && curl -fsSL ${quotedUrl} -o ${quotedDest}`;
      }

      async function copyToClipboard(text) {
        await navigator.clipboard.writeText(text);
      }

      function setStatus(text, variant) {
        const el = $("loadStatus");
        el.textContent = text;
        el.classList.remove("good", "bad");
        if (variant) el.classList.add(variant);
      }

      function normalizeCombo(value) {
        const cleaned = String(value || "")
          .trim()
          .toLowerCase()
          .replace(/\s+/g, " ")
          .replace(/\+/g, " ");
        const parts = cleaned.split(" ").filter(Boolean);
        if (parts.length < 2) return { tool: "", lang: "" };
        return { tool: parts[0], lang: parts[1] };
      }

      function normalizeQueryTokens(value) {
        const cleaned = String(value || "").trim().toLowerCase().replace(/\+/g, " ");
        return cleaned.split(/\s+/).filter(Boolean);
      }

      function scoreItem(item, tokens) {
        if (tokens.length === 0) return 1;
        const tool = String(item.tool || "").toLowerCase();
        const lang = String(item.lang || "").toLowerCase();
        const label = String(item.label || "").toLowerCase();
        const haystack = `${tool} ${lang} ${label}`;

        let score = 0;
        for (const token of tokens) {
          if (!token) continue;
          if (tool === token) score += 120;
          if (lang === token) score += 120;
          if (tool.startsWith(token)) score += 80;
          if (lang.startsWith(token)) score += 80;
          if (label.startsWith(token)) score += 55;
          if (haystack.includes(token)) score += 35;
        }

        // Bonus for combined "tool lang" in correct order
        if (tokens.length >= 2) {
          const two = `${tokens[0]} ${tokens[1]}`;
          if (`${tool} ${lang}`.startsWith(two)) score += 120;
        }
        return score;
      }

      function escapeHtml(value) {
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      async function main() {
        const query = parseQuery();
        const guessed = guessOwnerRepoFromPagesUrl();

        try {
          const res = await fetch("./registry.json", { cache: "no-store" });
          if (!res.ok) throw new Error(`registry fetch failed: ${res.status}`);
          const registry = await res.json();
          const items = (registry && registry.items) || [];
          const defaults = (registry && registry.defaults) || {};
          if (!Array.isArray(items) || items.length === 0) {
            throw new Error("registry has no items");
          }

          setStatus("Ready", "good");

          function resolveOwnerRepoRef() {
            const owner = (query.owner || guessed.owner || defaults.owner || "").trim();
            const repo = (query.repo || guessed.repo || defaults.repo || "").trim();
            const ref = (query.ref || defaults.ref || "main").trim();
            return { owner, repo, ref };
          }

          function showResult({ rawUrl, command }) {
            $("command").value = command;
            $("result").style.display = "block";
            $("rawUrlNote").innerHTML = `<a href="${rawUrl}" target="_blank" rel="noopener noreferrer"><code>${rawUrl}</code></a>`;
            $("openRaw").onclick = () => window.open(rawUrl, "_blank", "noopener,noreferrer");
          }

          function findItem(tool, lang) {
            return items.find((x) => x.tool === tool && x.lang === lang) || null;
          }

          let selected = null;
          let activeIndex = -1;

          function setSelected(item) {
            selected = item;
            if (!item) {
              $("selectedChip").style.display = "none";
              $("selectedLabel").textContent = "";
              return;
            }
            $("selectedChip").style.display = "inline-flex";
            $("selectedLabel").textContent = item.label || `${item.tool}+${item.lang}`;
          }

          function getResults() {
            const tokens = normalizeQueryTokens($("query").value);
            const scored = items
              .map((item) => ({ item, score: scoreItem(item, tokens) }))
              .filter((x) => x.score > 0)
              .sort((a, b) => b.score - a.score)
              .slice(0, 8);
            return scored.map((x) => x.item);
          }

          function openDropdown() {
            $("dropdown").classList.add("open");
          }

          function closeDropdown() {
            $("dropdown").classList.remove("open");
            activeIndex = -1;
          }

          function renderDropdown() {
            const results = getResults();
            const dropdown = $("dropdown");
            dropdown.innerHTML = "";

            if (results.length === 0) {
              closeDropdown();
              return;
            }

            results.forEach((item, index) => {
              const el = document.createElement("div");
              el.className = "option" + (index === activeIndex ? " active" : "");
              el.setAttribute("role", "option");
              el.dataset.tool = item.tool;
              el.dataset.lang = item.lang;
              const title = escapeHtml(item.label || `${item.tool}+${item.lang}`);
              const meta = escapeHtml(`${item.tool}+${item.lang}`);
              el.innerHTML = `<div class="optionTitle">${title}</div><div class="optionMeta">${meta}</div>`;
              el.addEventListener("mousedown", (e) => {
                e.preventDefault();
                setSelected(item);
                $("query").value = "";
                closeDropdown();
              });
              dropdown.appendChild(el);
            });

            openDropdown();
          }

          function setActiveIndex(index) {
            const results = getResults();
            if (results.length === 0) {
              activeIndex = -1;
              renderDropdown();
              return;
            }
            activeIndex = Math.max(0, Math.min(index, results.length - 1));
            renderDropdown();
          }

          $("query").addEventListener("input", () => {
            activeIndex = -1;
            renderDropdown();
          });
          $("query").addEventListener("focus", () => {
            renderDropdown();
          });
          $("query").addEventListener("keydown", (e) => {
            if (!$("dropdown").classList.contains("open") && (e.key === "ArrowDown" || e.key === "ArrowUp")) {
              renderDropdown();
            }
            if (e.key === "Escape") {
              closeDropdown();
              return;
            }
            if (e.key === "ArrowDown") {
              e.preventDefault();
              setActiveIndex(activeIndex + 1);
              return;
            }
            if (e.key === "ArrowUp") {
              e.preventDefault();
              setActiveIndex(activeIndex - 1);
              return;
            }
            if (e.key === "Enter") {
              const results = getResults();
              if (results.length === 0) return;
              e.preventDefault();
              const picked = results[Math.max(0, activeIndex)];
              setSelected(picked);
              $("query").value = "";
              closeDropdown();
            }
          });

          $("clearSelection").addEventListener("click", () => {
            setSelected(null);
            $("result").style.display = "none";
            $("query").focus();
          });

          document.addEventListener("click", (e) => {
            const target = e.target;
            if (!target) return;
            const inside = $("searchBox").contains(target) || $("dropdown").contains(target);
            if (!inside) closeDropdown();
          });

          if (query.q) {
            const { tool, lang } = normalizeCombo(query.q);
            const item = tool && lang ? findItem(tool, lang) : null;
            if (item) setSelected(item);
          }

          $("generate").addEventListener("click", async () => {
            if (!selected) {
              const typed = normalizeCombo($("query").value);
              const fromTyped = typed.tool && typed.lang ? findItem(typed.tool, typed.lang) : null;
              if (fromTyped) setSelected(fromTyped);
            }
            if (!selected) {
              setStatus("Pick one template first", "bad");
              $("result").style.display = "none";
              return;
            }
            const { owner, repo, ref } = resolveOwnerRepoRef();
            if (!owner || !repo) {
              setStatus("Missing owner/repo. Pass ?owner=...&repo=... or set defaults in registry.json", "bad");
              $("result").style.display = "none";
              return;
            }

            const rawUrl = buildRawUrl({ owner, repo, ref, path: selected.path });
            const dest = (query.dest || "AGENTS.md").trim() || "AGENTS.md";
            const command = buildCommand({ rawUrl, dest });
            showResult({ rawUrl, command });
            setStatus("Generated", "good");
          });

          $("copyCmd").addEventListener("click", async () => {
            const text = $("command").value;
            if (!text) return;
            await copyToClipboard(text);
            setStatus("Command copied", "good");
          });
        } catch (err) {
          setStatus(`Error: ${err && err.message ? err.message : String(err)}`, "bad");
        }
      }

      main();
    </script>
  </body>
</html>
